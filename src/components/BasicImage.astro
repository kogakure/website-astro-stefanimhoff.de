---
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import TextLink from './TextLink.astro';
import Link from './Link.astro';

interface Props {
	alt?: string;
	caption?: string;
	class?: string;
	decoding?: 'async' | 'sync' | 'auto';
	height?: string | number;
	href?: string;
	loading?: 'lazy' | 'eager';
	noSpacing?: boolean;
	quality?: number;
	size?: 'regular' | 'wide' | 'fullsize';
	source?: string;
	sourceUrl?: string;
	src: string;
	width?: string | number;
}

const {
	alt,
	caption,
	class: className,
	decoding = 'async',
	height,
	href,
	loading = 'lazy',
	noSpacing,
	quality,
	size,
	source,
	sourceUrl,
	src,
	width,
	...props
} = Astro.props;

// Normalize dimensions
const parseDim = (dim: string | number | undefined) => (dim ? Number(dim) : undefined);
const parsedWidth = parseDim(width);
const parsedHeight = parseDim(height);

// Resolve Image Source
let localImage: ImageMetadata | undefined;
let remoteImage: string = src;

// Get all the image metadata
const images = import.meta.glob<{ default: ImageMetadata }>('/src/images/**/*');

if (src.startsWith('/images')) {
	const key = '/src' + src;
	const loader = images[key as keyof typeof images];

	if (typeof loader === 'function') {
		const mod = await loader();
		localImage = mod.default;
	}
}

// Define sizes attribute for responsive images
const sizes = '(max-width: 440px) 100vw, (max-width: 768px) 90vw, (max-width: 1024px) 85vw, 1100px';

// Determine the tag and specific attributes
const ImageWrapper = href ? Link : 'div';
const wrapperProps = href ? { href } : {};
---

<figure
	class:list={[
		'mbs-0 mie-0 mis-0',
		{
			'figure-wide': size === 'wide',
			'figure-fullsize': size === 'fullsize',
			'mbe-13': true,
		},
		className,
	]}
	{...props}
>
	<ImageWrapper
		class="figure-content flex flex-wrap gap-6 md:flex-nowrap [&_div]:flex-grow"
		{...wrapperProps}
	>
		{
			localImage ? (
				<Picture
					alt={alt ?? ''}
					class="rounded-2"
					decoding={decoding}
					formats={['avif', 'webp', 'jpg', 'png']}
					loading={loading}
					quality={quality}
					sizes={sizes}
					src={localImage}
					width={parsedWidth}
					height={parsedHeight}
				/>
			) : (
				<img
					alt={alt ?? ''}
					class="rounded-2"
					loading={loading}
					src={remoteImage}
					width={parsedWidth}
					height={parsedHeight}
				/>
			)
		}
	</ImageWrapper>
	{
		(caption || source) && (
			<figcaption class="text-center text-2 mbs-2 [text-wrap:balance]">
				{caption}
				{caption && source ? 'â€“' : ''}
				{source &&
					(sourceUrl ? (
						<cite>
							<TextLink href={sourceUrl}>{source}</TextLink>
						</cite>
					) : (
						<cite>{source}</cite>
					))}
			</figcaption>
		)
	}
</figure>
